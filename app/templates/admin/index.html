{% extends 'base.html' %}
{% block title %}Admin Console · TrackYourSheets{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">Organization</h2>
      </div>
      <div class="card-body">
        <h3 class="h5 mb-1">{{ org.name }}</h3>
        <p class="text-muted small mb-3">Plan: {{ org.plan.name if org.plan else 'Unassigned' }}</p>
        <form method="post" action="#" class="mb-3">
          <div class="alert alert-info small">Billing plan changes are handled via Stripe Customer Portal integration.</div>
        </form>
        <h4 class="h6 text-uppercase text-muted mt-4">Usage</h4>
        <ul class="list-unstyled small">
          <li><strong>{{ users|length }}</strong> users</li>
          <li><strong>{{ carriers|length }}</strong> carriers</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Team</h2>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#inviteUserModal">Invite</button>
      </div>
      <div class="list-group list-group-flush">
        {% for user in users %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-semibold">{{ user.email }}</div>
            <div class="text-muted small">{{ user.role|capitalize }}</div>
          </div>
          {% if user.id != current_user.id %}
          <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
            <button class="btn btn-outline-danger btn-sm">Remove</button>
          </form>
          {% endif %}
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">No teammates yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Carriers</h2>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCarrierModal">Add</button>
      </div>
      <div class="list-group list-group-flush">
        {% for carrier in carriers %}
        <div class="list-group-item">
          <div class="fw-semibold">{{ carrier.name }}</div>
          <div class="small text-muted">{{ carrier.download_type|upper }} import</div>
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">Add your first carrier to start mapping statements.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-xl-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Commission rulesets</h2>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createRulesetModal">New ruleset</button>
      </div>
      <div class="list-group list-group-flush">
        {% for ruleset in rulesets %}
        <a class="list-group-item list-group-item-action d-flex justify-content-between" href="{{ url_for('admin.manage_rules', ruleset_id=ruleset.id) }}">
          <div>
            <div class="fw-semibold">{{ ruleset.name }}</div>
            <div class="small text-muted">Version {{ ruleset.version }} · Effective {{ ruleset.effective_from.strftime('%b %d, %Y') if ruleset.effective_from else 'TBD' }}</div>
          </div>
          <span class="badge bg-success-soft text-success">{{ ruleset.rules|length }} rules</span>
        </a>
        {% else %}
        <div class="list-group-item text-center text-muted">Create a ruleset to automate producer splits.</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">API keys</h2>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">Generate</button>
      </div>
      <div class="list-group list-group-flush">
        {% for key in api_keys %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">{{ key.label }}</div>
              <div class="text-muted small">Scopes: {{ key.scopes|join(', ') }}</div>
            </div>
            <span class="badge bg-secondary">Token stored securely</span>
          </div>
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">No API keys yet. Enable webhooks or integrations to generate one.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Invite User Modal -->
<div class="modal fade" id="inviteUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_user') }}">
        <div class="modal-header">
          <h5 class="modal-title">Invite teammate</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" class="form-select">
              <option value="admin">Admin</option>
              <option value="bookkeeper">Bookkeeper</option>
              <option value="producer">Producer</option>
              <option value="auditor">Read-only auditor</option>
            </select>
          </div>
          <div class="alert alert-warning small mb-0">An activation email workflow can be connected via transactional email providers.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Send invite</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Carrier Modal -->
<div class="modal fade" id="addCarrierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_carrier') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add carrier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Carrier name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Import format</label>
            <select name="download_type" class="form-select">
              <option value="csv">CSV</option>
              <option value="pdf">PDF (OCR beta)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save carrier</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Ruleset Modal -->
<div class="modal fade" id="createRulesetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_ruleset') }}">
        <div class="modal-header">
          <h5 class="modal-title">New ruleset</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ruleset name</label>
            <input type="text" name="name" class="form-control" placeholder="2024 Auto Standard" required>
          </div>
          <div class="alert alert-info small mb-0">Rulesets are versioned automatically. Clone existing configurations as you iterate.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create ruleset</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_api_key') }}">
        <div class="modal-header">
          <h5 class="modal-title">Generate API key</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Label</label>
            <input type="text" name="label" class="form-control" placeholder="Zapier outbound" required>
          </div>
          <div class="alert alert-warning small mb-0">API keys are hashed at rest. Copy the plaintext token immediately after generating.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Generate key</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
