{% extends 'base.html' %}
{% block title %}Admin Console · TrackYourSheets{% endblock %}
{% block content %}
{% set active_tab = 'overview' %}
{% include 'admin/_subnav.html' %}
{% set agent_users = users | selectattr('role', 'equalto', 'agent') | list %}
<div class="row g-4">
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">Organization</h2>
      </div>
      <div class="card-body">
        <h3 class="h5 mb-1">{{ org.name }}</h3>
        {% if org.plan %}
        <p class="text-muted small mb-1">Plan: {{ org.plan.name }}</p>
        {% if current_plan_detail and current_plan_detail.price_label %}
        <p class="text-muted small mb-3">Billing: {{ current_plan_detail.price_label }} / user / {{ current_plan_detail.billing_interval }}</p>
        {% else %}
        <p class="text-muted small mb-3">Billing: Contact support to confirm pricing</p>
        {% endif %}
        {% else %}
        <p class="text-muted small mb-3">Plan: <span class="text-warning">Not set</span></p>
        {% endif %}
        <h4 class="h6 text-uppercase text-muted mt-4">Usage</h4>
        <ul class="list-unstyled small mb-0">
          <li>
            <strong>{{ seat_usage }}</strong> active seat{{ '' if seat_usage == 1 else 's' }}
            {% if plan_limits and plan_limits['max_users'] %}
            <span class="text-muted">of {{ plan_limits['max_users'] }}</span>
            {% endif %}
          </li>
          <li><strong>{{ workspaces|length }}</strong> workspace{{ '' if workspaces|length == 1 else 's' }}</li>
          <li>
            <strong>{{ producer_usage }}</strong> producer{{ '' if producer_usage == 1 else 's' }}
            {% if plan_limits and not plan_limits['includes_producer_portal'] %}
            <span class="badge bg-warning-soft text-warning ms-1">Upgrade for portals</span>
            {% endif %}
          </li>
          <li>
            <strong>{{ carrier_usage }}</strong> carrier{{ '' if carrier_usage == 1 else 's' }}
            {% if plan_limits and plan_limits['max_carriers'] %}
            <span class="text-muted">of {{ plan_limits['max_carriers'] }}</span>
            {% endif %}
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Workspaces</h2>
        {% if current_user.role in ['owner', 'admin'] %}
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createWorkspaceModal">New workspace</button>
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#createOfficeModal">New office</button>
        </div>
        {% endif %}
      </div>
      <div class="list-group list-group-flush">
        {% for workspace in workspaces %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div>
              <div class="fw-semibold">{{ workspace.name }}</div>
              <div class="small text-muted">
                {% if workspace.office %}{{ workspace.office.name }} · {% endif %}
                {% if workspace.agent %}Agent: {{ workspace.agent.email }}{% else %}No agent assigned{% endif %}
              </div>
              <div class="small text-muted">{{ workspace.producers|length }} producer{{ '' if workspace.producers|length == 1 else 's' }}</div>
            </div>
            {% if current_user.role in ['owner', 'admin'] and agent_users %}
            <form class="d-flex gap-2" method="post" action="{{ url_for('admin.assign_workspace_agent', workspace_id=workspace.id) }}">
              <select name="agent_user_id" class="form-select form-select-sm">
                <option value="">Assign agent</option>
                {% for agent in agent_users %}
                <option value="{{ agent.id }}" {% if workspace.agent_id == agent.id %}selected{% endif %}>{{ agent.email }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-sm btn-outline-primary">Save</button>
            </form>
            {% elif current_user.role == 'agent' and workspace.agent_id == current_user.id %}
            <span class="badge bg-success-soft text-success">Managed</span>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">No workspaces yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">{{ 'Producers' if current_user.role == 'agent' else 'Team' }}</h2>
        {% if plan_permissions.can_invite_producers %}
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#inviteUserModal">{{ 'Add producer' if current_user.role == 'agent' else 'Invite' }}</button>
        {% else %}
        <button class="btn btn-sm btn-outline-secondary" type="button" disabled>Upgrade to invite producers</button>
        {% endif %}
      </div>
      <div class="list-group list-group-flush">
        {% for user in users %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <div class="fw-semibold">{{ user.email }}</div>
            <div class="text-muted small">
              {{ user.role|capitalize }}
              {% if user.managed_workspace %} · Agent of {{ user.managed_workspace.name }}{% elif user.producer %} · Producer in {{ user.producer.workspace.name }}{% endif %}
            </div>
          </div>
          {% if user.id != current_user.id %}
          <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
            <button class="btn btn-outline-danger btn-sm">Remove</button>
          </form>
          {% endif %}
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">No teammates yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Producers</h2>
        <div class="btn-group">
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin.leaderboard') }}">Leaderboard</a>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin.manage_categories') }}">Categories</a>
        </div>
      </div>
      <div class="list-group list-group-flush">
        {% for producer in producers %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">{{ producer.display_name }}</div>
              <div class="text-muted small">{{ producer.workspace.name if producer.workspace else 'Unassigned workspace' }}</div>
            </div>
            <span class="badge bg-secondary">Split {{ producer.default_split }}%</span>
          </div>
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">Producers appear here after you invite them to a workspace.</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Carriers</h2>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCarrierModal">Add</button>
      </div>
      <div class="list-group list-group-flush">
        {% for carrier in carriers %}
        <div class="list-group-item">
          <div class="fw-semibold">{{ carrier.name }}</div>
          <div class="small text-muted">{{ carrier.download_type|upper }} import</div>
        </div>
        {% else %}
        <div class="list-group-item text-center text-muted">Add your first carrier to start mapping statements.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Knowledge base</h2>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin.how_to') }}">Open guide</a>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-2">Step-by-step instructions for agents, producers, bookkeepers, auditors, admins, and read-only teammates are embedded directly in the app.</p>
        <p class="text-muted small mb-0">Bookmark the guide so new hires can onboard themselves in minutes.</p>
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Analytics</h2>
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('reports.analytics_dashboard') }}">View charts</a>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-2">Interactive charts update instantly as you filter by category, business type, producer, team, and period.</p>
        <p class="text-muted small mb-0">Export filtered datasets as CSV or PDF to share performance snapshots with leadership.</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Commission rulesets</h2>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createRulesetModal">New ruleset</button>
      </div>
      <div class="list-group list-group-flush">
        {% for ruleset in rulesets %}
        <a class="list-group-item list-group-item-action d-flex justify-content-between" href="{{ url_for('admin.manage_rules', ruleset_id=ruleset.id) }}">
          <div>
            <div class="fw-semibold">{{ ruleset.name }}</div>
            <div class="small text-muted">Version {{ ruleset.version }} · Effective {{ ruleset.effective_from.strftime('%b %d, %Y') if ruleset.effective_from else 'TBD' }}</div>
          </div>
          <span class="badge bg-success-soft text-success">{{ ruleset.rules|length }} rules</span>
        </a>
        {% else %}
        <div class="list-group-item text-center text-muted">Create a ruleset to automate producer splits.</div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">API keys</h2>
        {% if current_user.role in ['owner', 'admin'] %}
        {% if plan_permissions.can_create_api_keys %}
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createApiKeyModal">Generate</button>
        {% else %}
        <span class="badge bg-warning-soft text-warning">Upgrade for API access</span>
        {% endif %}
        {% endif %}
      </div>
      {% if revealed_api_key %}
      <div class="alert alert-success border-0 rounded-0 mb-0">
        <div class="fw-semibold">New API key created — copy or download it now.</div>
        <p class="small mb-2">This token will not be displayed again after you leave this page.</p>
        <div class="input-group input-group-sm">
          <input type="text" class="form-control" value="{{ revealed_api_key.token }}" readonly>
          <a class="btn btn-outline-primary" href="{{ url_for('admin.download_api_key', key_id=revealed_api_key.id) }}">Download .txt</a>
        </div>
      </div>
      {% endif %}
      <div class="list-group list-group-flush">
        {% if api_keys %}
        {% for key in api_keys %}
        <div class="list-group-item">
          <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
            <div>
              <div class="fw-semibold d-flex align-items-center gap-2">
                <span>{{ key.label }}</span>
                {% if not key.is_active %}
                <span class="badge bg-danger-soft text-danger">Revoked</span>
                {% endif %}
              </div>
              <div class="text-muted small">Scopes: {{ (key.scopes or [])|join(', ') or '—' }}</div>
              <div class="text-muted small">Key: {{ key.masked_token }}</div>
              <div class="text-muted small">Created {{ key.created_at.strftime('%b %d, %Y') }}</div>
            </div>
            <div class="d-flex align-items-center gap-2">
              {% if key.is_active and (key.id|string) in downloadable_api_keys %}
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin.download_api_key', key_id=key.id) }}">Download .txt</a>
              {% endif %}
              {% if key.is_active and current_user.role in ['owner', 'admin'] %}
              <form method="post" action="{{ url_for('admin.revoke_api_key', key_id=key.id) }}" onsubmit="return confirm('Revoke this API key? Integrations using it will stop working.');">
                <button type="submit" class="btn btn-sm btn-outline-danger">Revoke</button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
        {% elif current_user.role in ['owner', 'admin'] %}
        <div class="list-group-item text-center text-muted">Generate keys to connect Zapier, QuickBooks syncs, or partner APIs.</div>
        {% else %}
        <div class="list-group-item text-center text-muted">Available for organization owners via the Scale plan.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Invite User Modal -->
<div class="modal fade" id="inviteUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_user') }}">
        <div class="modal-header">
          <h5 class="modal-title">{{ 'Add producer' if current_user.role == 'agent' else 'Invite teammate' }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" required>
          </div>
          {% if current_user.role in ['owner', 'admin'] %}
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" class="form-select">
              <option value="admin">Admin</option>
              <option value="agent">Agent</option>
              <option value="bookkeeper">Bookkeeper</option>
              <option value="producer" {% if not plan_permissions.can_invite_producers %}disabled{% endif %}>Producer {% if not plan_permissions.can_invite_producers %}(Upgrade required){% endif %}</option>
              <option value="auditor">Read-only auditor</option>
            </select>
          </div>
          {% else %}
          <input type="hidden" name="role" value="producer">
          {% endif %}
          {% if workspaces %}
          <div class="mb-3">
            <label class="form-label">Workspace</label>
            {% if current_user.role == 'agent' and workspaces|length == 1 %}
            <input type="hidden" name="workspace_id" value="{{ workspaces[0].id }}">
            <input type="text" class="form-control" value="{{ workspaces[0].name }}" disabled>
            {% else %}
            <select name="workspace_id" class="form-select">
              <option value="">Select workspace (required for agents/producers)</option>
              {% for workspace in workspaces %}
              <option value="{{ workspace.id }}">{{ workspace.office.name ~ ' · ' if workspace.office }}{{ workspace.name }}</option>
              {% endfor %}
            </select>
            {% endif %}
          </div>
          {% endif %}
          <div class="mb-3">
            <label class="form-label">Display name (for producers)</label>
            <input type="text" name="display_name" class="form-control" placeholder="Jane Producer">
          </div>
          <div class="mb-0 alert alert-info small">Temporary password will default to <code>ChangeMe123!</code>. Update after first login.</div>
          {% if not plan_permissions.can_invite_producers %}
          <div class="alert alert-warning small mt-3 mb-0">Producer access is locked on your current plan. Upgrade to unlock producer portals.</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">{{ 'Add producer' if current_user.role == 'agent' else 'Send invite' }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Office Modal -->
<div class="modal fade" id="createOfficeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_office') }}">
        <div class="modal-header">
          <h5 class="modal-title">New office</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Office name</label>
            <input type="text" name="name" class="form-control" placeholder="Austin HQ" required>
          </div>
          <div class="mb-0">
            <label class="form-label">Timezone (optional)</label>
            <input type="text" name="timezone" class="form-control" placeholder="America/Chicago">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create office</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Workspace Modal -->
<div class="modal fade" id="createWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_workspace') }}">
        <div class="modal-header">
          <h5 class="modal-title">New workspace</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Workspace name</label>
            <input type="text" name="name" class="form-control" placeholder="Austin · Commercial" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Office</label>
            <select name="office_id" class="form-select" required>
              <option value="" disabled selected>Select office</option>
              {% for office in offices %}
              <option value="{{ office.id }}">{{ office.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-0">
            <label class="form-label">Agent (optional)</label>
            <select name="agent_id" class="form-select">
              <option value="">Assign later</option>
              {% for agent in agent_users %}
              <option value="{{ agent.id }}">{{ agent.email }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create workspace</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Carrier Modal -->
<div class="modal fade" id="addCarrierModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_carrier') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add carrier</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Carrier name</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-0">
            <label class="form-label">Import format</label>
            <select name="download_type" class="form-select">
              <option value="csv">CSV</option>
              <option value="pdf">PDF (OCR beta)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save carrier</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Ruleset Modal -->
<div class="modal fade" id="createRulesetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_ruleset') }}">
        <div class="modal-header">
          <h5 class="modal-title">New ruleset</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Ruleset name</label>
            <input type="text" name="name" class="form-control" placeholder="2024 Auto Standard" required>
          </div>
          <div class="alert alert-info small mb-0">Rulesets are versioned automatically. Clone existing configurations as you iterate.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create ruleset</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('admin.create_api_key') }}">
        <div class="modal-header">
          <h5 class="modal-title">Generate API key</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Label</label>
            <input type="text" name="label" class="form-control" placeholder="Zapier Automation" required>
          </div>
          <div class="alert alert-warning small mb-0">Tokens are generated as placeholders. Replace with secure storage before production use.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Generate key</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
