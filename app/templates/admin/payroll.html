{% extends 'base.html' %}
{% block title %}Payroll · TrackYourSheets{% endblock %}
{% block content %}
{% set active_tab = 'payroll' %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
  <div>
    <h1 class="h3 mb-1">Commission payroll</h1>
    <p class="text-muted mb-0">Roll up approved commissions, review producer totals, and send payouts through Stripe in a single workflow.</p>
  </div>
</div>

{% include 'admin/_subnav.html' %}

<form class="card shadow-sm mb-4" method="get">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h2 class="h6 mb-0">Pay period</h2>
    <span class="text-muted small">Showing commissions between {{ date_from.strftime('%b %d, %Y') }} and {{ date_to.strftime('%b %d, %Y') }}</span>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label" for="date_from">From</label>
        <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from.isoformat() }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="date_to">To</label>
        <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to.isoformat() }}">
      </div>
      <div class="col-md-4 d-grid">
        <button type="submit" class="btn btn-outline-primary">Refresh totals</button>
      </div>
    </div>
  </div>
</form>

<div class="row g-4">
  <div class="col-xl-8">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Producer payout preview</h2>
        <span class="badge bg-primary-soft text-primary">Total ${{ '{:,.2f}'.format(total_commission or 0) }}</span>
      </div>
      <div class="card-body">
        {% if payroll_rows %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">Producer</th>
                <th scope="col">Transactions</th>
                <th scope="col">Average</th>
                <th scope="col">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for row in payroll_rows %}
              <tr>
                <td class="fw-semibold">{{ row.producer_name }}</td>
                <td class="text-muted small">{{ row.transaction_count }}</td>
                <td class="text-muted small">${{ '{:,.2f}'.format(row.average_amount) }}</td>
                <td class="fw-semibold">${{ '{:,.2f}'.format(row.commission_total) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">No commission transactions found for this period.</p>
        {% endif %}
      </div>
      <div class="card-footer bg-light">
        <form method="post" class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
          <div class="flex-grow-1">
            <label class="form-label small" for="payroll-notes">Internal note (optional)</label>
            <input type="text" class="form-control form-control-sm" id="payroll-notes" name="notes" placeholder="e.g. Bonus adjustments included for March renewals">
          </div>
          <div class="text-lg-end">
            {% if payroll_rows %}
            <button type="submit" class="btn btn-primary" {% if not stripe_ready and total_commission <= 0 %}disabled{% endif %}>Create payroll run{% if stripe_ready %} &amp; send to Stripe{% endif %}</button>
            {% else %}
            <button type="button" class="btn btn-primary" disabled>Nothing to pay</button>
            {% endif %}
            {% if not stripe_ready %}
            <div class="small text-muted mt-2">Stripe not configured — run will be saved for manual payment.</div>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">Status mix</h2>
      </div>
      <div class="card-body">
        {% if status_summary %}
        <ul class="list-group list-group-flush">
          {% for row in status_summary %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="text-uppercase small text-muted">{{ row.status.replace('_', ' ') }}</div>
              <div class="fw-semibold">${{ '{:,.2f}'.format(row.amount) }}</div>
            </div>
            <span class="badge bg-secondary-soft text-secondary">{{ row.count }}</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small mb-0">No transactions to summarise.</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">Recent payroll runs</h2>
      </div>
      <div class="card-body">
        {% if previous_runs %}
        <ul class="list-group list-group-flush">
          {% for run in previous_runs %}
          <li class="list-group-item">
            <div class="fw-semibold">{{ run.period_start.strftime('%b %d') }} – {{ run.period_end.strftime('%b %d, %Y') }}</div>
            <div class="small text-muted">${{ '{:,.2f}'.format(run.total_payout or 0) }} · {{ run.status.replace('_', ' ') }}</div>
            {% if run.stripe_payout_id %}
            <div class="small text-muted">Stripe payout: {{ run.stripe_payout_status or 'submitted' }}</div>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small mb-0">No payroll runs recorded yet.</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">Latest commission activity</h2>
      </div>
      <div class="card-body">
        {% if recent_transactions %}
        <ul class="list-group list-group-flush">
          {% for txn in recent_transactions %}
          <li class="list-group-item">
            <div class="fw-semibold">{{ txn.producer.display_name if txn.producer else 'Unassigned' }}</div>
            <div class="text-muted small">${{ '{:,.2f}'.format(txn.amount or 0) }} on {{ txn.txn_date.strftime('%b %d, %Y') }}</div>
            <div class="text-muted small">Status: {{ txn.status }}</div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small mb-0">No recent transactions in this period.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
