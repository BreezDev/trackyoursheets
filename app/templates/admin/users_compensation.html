{% extends 'base.html' %}
{% block title %}User Compensation · TrackYourSheets{% endblock %}
{% block content %}
{% set active_tab = 'users' %}
{% include 'admin/_subnav.html' %}

<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
  <div>
    <h1 class="h3 mb-1">Compensation overview</h1>
    <p class="text-muted mb-0">Track base salaries, bonus plans, and workspace coverage for everyone in your organisation.</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.manage_user_compensation', export='csv') }}">Export CSV</a>
    <a class="btn btn-primary" href="{{ url_for('hr.dashboard') }}">Open HR portal</a>
  </div>
</div>

<div class="alert alert-info d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2" role="alert">
  <div>
    <strong>Total base salary:</strong> ${{ '{:,.2f}'.format(totals.base) }} ·
    <strong>Total bonus target:</strong> ${{ '{:,.2f}'.format(totals.bonus) }}
  </div>
  <span class="small text-muted">Updates sync with HR profiles, payroll runs, and exports.</span>
</div>

<div class="table-responsive">
  <table class="table align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col">Teammate</th>
        <th scope="col">Role</th>
        <th scope="col">Workspaces</th>
        <th scope="col">Base salary</th>
        <th scope="col">Bonus plan</th>
        <th scope="col">Bonus target</th>
        <th scope="col">Currency</th>
        <th scope="col">Notes</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td>
          <div class="fw-semibold">{{ user.display_name_for_ui }}</div>
          <div class="text-muted small">{{ user.email }}</div>
        </td>
        <td>{{ user.role|capitalize }}</td>
        <td class="small text-muted">
          {% set workspace_labels = [] %}
          {% for membership in user.workspace_memberships %}
            {% if membership.workspace %}
              {% set _ = workspace_labels.append(membership.workspace.name) %}
            {% endif %}
          {% endfor %}
          {{ workspace_labels|join(', ') if workspace_labels else '—' }}
        </td>
        <td>
          <input type="number" step="0.01" min="0" name="base_salary" class="form-control form-control-sm" value="{{ '{:,.2f}'.format(user.base_salary) if user.base_salary is not none else '' }}" placeholder="0.00" form="comp-{{ user.id }}">
        </td>
        <td>
          <input type="text" name="bonus_plan" class="form-control form-control-sm" value="{{ user.bonus_plan or '' }}" placeholder="Plan" form="comp-{{ user.id }}">
        </td>
        <td>
          <input type="number" step="0.01" min="0" name="bonus_target" class="form-control form-control-sm" value="{{ '{:,.2f}'.format(user.bonus_target) if user.bonus_target is not none else '' }}" placeholder="0.00" form="comp-{{ user.id }}">
        </td>
        <td>
          <input type="text" name="currency" class="form-control form-control-sm" value="{{ user.compensation_currency }}" maxlength="8" form="comp-{{ user.id }}">
        </td>
        <td>
          <input type="text" name="notes" class="form-control form-control-sm" value="{{ user.compensation_notes or '' }}" placeholder="Internal notes" form="comp-{{ user.id }}">
        </td>
        <td>
          <form method="post" id="comp-{{ user.id }}" class="d-flex flex-column gap-2 align-items-end">
            <input type="hidden" name="user_id" value="{{ user.id }}">
            <button type="submit" class="btn btn-sm btn-primary">Save</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8" class="text-center text-muted py-4">No teammates yet. Invite your first user from the admin overview.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
