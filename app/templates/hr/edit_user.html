{% extends 'base.html' %}
{% block title %}Employee Profile · TrackYourSheets{% endblock %}
{% block content %}
{% set active_tab = 'directory' %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
  <div>
    <h1 class="h3 mb-1">Manage {{ user.display_name_for_ui }}</h1>
    <p class="text-muted mb-0">Update contact info, job details, and review payroll or HR activity for this teammate.</p>
  </div>
  <div class="mt-3 mt-lg-0">
    <a class="btn btn-outline-secondary" href="{{ url_for('hr.directory') }}">Back to directory</a>
  </div>
</div>

{% include 'hr/_subnav.html' %}

<form method="post" class="card shadow-sm mb-4">
  <input type="hidden" name="intent" value="profile">
  <div class="card-header bg-light">
    <h2 class="h6 mb-0">Profile &amp; employment info</h2>
  </div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label" for="first_name">First name</label>
        <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="last_name">Last name</label>
        <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="preferred_name">Preferred name</label>
        <input type="text" class="form-control" id="preferred_name" name="preferred_name" value="{{ user.preferred_name or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="job_title">Job title</label>
        <input type="text" class="form-control" id="job_title" name="job_title" value="{{ user.job_title or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="phone_number">Phone</label>
        <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ user.phone_number or '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="role">Role</label>
        <select class="form-select" id="role" name="role">
          {% for role in ['owner', 'admin', 'agent', 'bookkeeper', 'hr', 'producer', 'staff'] %}
          <option value="{{ role }}" {% if user.role == role %}selected{% endif %}>{{ role|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label" for="status">Status</label>
        <select class="form-select" id="status" name="status">
          {% for status in ['active', 'invited', 'inactive', 'suspended'] %}
          <option value="{{ status }}" {% if user.status == status %}selected{% endif %}>{{ status|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="must_change_password" name="must_change_password" {% if user.must_change_password %}checked{% endif %}>
          <label class="form-check-label" for="must_change_password">Require password reset</label>
        </div>
      </div>
      {% if user.producer %}
      <div class="col-md-4">
        <label class="form-label" for="producer_display_name">Commission display name</label>
        <input type="text" class="form-control" id="producer_display_name" name="producer_display_name" value="{{ user.producer.display_name }}">
      </div>
      {% endif %}
      <div class="col-md-4">
        <label class="form-label" for="emergency_name">Emergency contact</label>
        <input type="text" class="form-control" id="emergency_name" name="emergency_name" value="{{ user.emergency_contact.name if user.emergency_contact else '' }}" placeholder="Full name">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="emergency_phone">Emergency phone</label>
        <input type="text" class="form-control" id="emergency_phone" name="emergency_phone" value="{{ user.emergency_contact.phone if user.emergency_contact else '' }}">
      </div>
      <div class="col-md-4">
        <label class="form-label" for="emergency_relation">Relationship</label>
        <input type="text" class="form-control" id="emergency_relation" name="emergency_relation" value="{{ user.emergency_contact.relationship if user.emergency_contact else '' }}">
      </div>
    </div>
  </div>
  <div class="card-footer bg-light d-flex justify-content-end">
    <button type="submit" class="btn btn-primary">Save profile</button>
  </div>
</form>

<div class="row g-4 mb-4">
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Workspace assignments</h2>
        <span class="badge bg-primary-soft text-primary">{{ user.workspace_memberships|length }} total</span>
      </div>
      <div class="card-body">
        {% if user.workspace_memberships %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Workspace</th>
                <th>Role</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for membership in user.workspace_memberships %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ membership.workspace.name if membership.workspace else 'Workspace removed' }}</div>
                  <div class="text-muted small">{% if membership.workspace and membership.workspace.office %}{{ membership.workspace.office.name }} · {% endif %}{{ membership.workspace.organization.name if membership.workspace else '—' }}</div>
                </td>
                <td><span class="badge bg-secondary">{{ membership.role or user.role }}</span></td>
                <td class="text-end">
                  <form method="post" class="d-inline">
                    <input type="hidden" name="intent" value="remove_workspace_membership">
                    <input type="hidden" name="membership_id" value="{{ membership.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted small mb-0">No workspace access yet. Add them below.</p>
        {% endif %}
      </div>
      <div class="card-footer bg-light">
        {% set assigned_ids = user.workspace_memberships | map(attribute='workspace_id') | list %}
        {% set available_workspaces = all_workspaces | rejectattr('id', 'in', assigned_ids) | list %}
        <form method="post" class="row g-2 align-items-end">
          <input type="hidden" name="intent" value="add_workspace_membership">
          <div class="col-md-7">
            <label class="form-label">Workspace</label>
            <select name="workspace_id" class="form-select" required {% if not available_workspaces %}disabled{% endif %}>
              <option value="">Select workspace</option>
              {% for workspace in available_workspaces %}
              <option value="{{ workspace.id }}">{{ workspace.office.name ~ ' · ' if workspace.office }}{{ workspace.name }}</option>
              {% endfor %}
              {% if not available_workspaces %}
              <option value="" disabled>All workspaces assigned</option>
              {% endif %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Role</label>
            <select name="workspace_role" class="form-select">
              <option value="">Default ({{ user.role }})</option>
              {% for role in ['owner','admin','agent','bookkeeper','hr','producer','staff','viewer'] %}
              <option value="{{ role }}">{{ role|capitalize }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100" {% if not available_workspaces %}disabled{% endif %}>Add</button>
          </div>
        </form>
        <p class="form-text small mb-0">Assignments sync with dashboard chat, notes, and payroll visibility.</p>
      </div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Office coverage</h2>
        <span class="badge bg-primary-soft text-primary">{{ user.office_memberships|length }} total</span>
      </div>
      <div class="card-body">
        {% if user.office_memberships %}
        <ul class="list-group list-group-flush mb-3">
          {% for membership in user.office_memberships %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">{{ membership.office.name if membership.office else 'Office removed' }}</div>
              <div class="text-muted small">Added {{ membership.created_at.strftime('%b %d, %Y') if membership.created_at else '—' }}</div>
            </div>
            <form method="post" class="ms-3">
              <input type="hidden" name="intent" value="remove_office_membership">
              <input type="hidden" name="membership_id" value="{{ membership.id }}">
              <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
            </form>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small mb-0">No office assignments yet.</p>
        {% endif %}
      </div>
      <div class="card-footer bg-light">
        {% set assigned_office_ids = user.office_memberships | map(attribute='office_id') | list %}
        {% set available_offices = all_offices | rejectattr('id', 'in', assigned_office_ids) | list %}
        <form method="post" class="row g-2 align-items-end">
          <input type="hidden" name="intent" value="add_office_membership">
          <div class="col-md-8">
            <label class="form-label">Office</label>
            <select name="office_id" class="form-select" required {% if not available_offices %}disabled{% endif %}>
              <option value="">Select office</option>
              {% for office in available_offices %}
              <option value="{{ office.id }}">{{ office.name }}</option>
              {% endfor %}
              {% if not available_offices %}
              <option value="" disabled>All offices assigned</option>
              {% endif %}
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100" {% if not available_offices %}disabled{% endif %}>Add</button>
          </div>
        </form>
        <p class="form-text small mb-0">Offices determine onboarding cohorts, policy acknowledgements, and HR alerts.</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Compensation</h2>
        <span class="badge bg-info-soft text-info">{{ user.compensation_currency }}</span>
      </div>
      <form method="post">
        <input type="hidden" name="intent" value="compensation">
        <div class="card-body">
          <p class="text-muted small">Capture base salary, bonus plans, and notes for payroll exports.</p>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Currency</label>
              <input type="text" name="compensation_currency" class="form-control" value="{{ user.compensation_currency }}" maxlength="8">
            </div>
            <div class="col-md-4">
              <label class="form-label">Base salary</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" step="0.01" min="0" name="base_salary" class="form-control" value="{{ '{:,.2f}'.format(user.base_salary) if user.base_salary is not none else '' }}" placeholder="0.00">
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Bonus target</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" step="0.01" min="0" name="bonus_target" class="form-control" value="{{ '{:,.2f}'.format(user.bonus_target) if user.bonus_target is not none else '' }}" placeholder="0.00">
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Bonus plan</label>
              <input type="text" name="bonus_plan" class="form-control" value="{{ user.bonus_plan or '' }}" placeholder="Quarterly accelerator, renewals, etc.">
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea name="compensation_notes" rows="3" class="form-control" placeholder="Eligibility, draw recoverables, commission overrides…">{{ user.compensation_notes or '' }}</textarea>
              <div class="form-text small">Visible to HR, admins, and payroll processors.</div>
            </div>
          </div>
        </div>
        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
          <span class="text-muted small">{{ user.compensation_summary }}</span>
          <button type="submit" class="btn btn-primary">Save compensation</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">Document acknowledgements</h2>
      </div>
      <div class="card-body">
        {% if acknowledgements %}
        <ul class="list-group list-group-flush">
          {% for ack in acknowledgements %}
          <li class="list-group-item">
            <div class="fw-semibold">{{ ack.document.title }}</div>
            <div class="text-muted small">{{ ack.acknowledged_at.strftime('%b %d, %Y %I:%M %p') if ack.acknowledged_at else '—' }}</div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small mb-0">No acknowledgements recorded yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light">
        <h2 class="h6 mb-0">HR interactions</h2>
      </div>
      <div class="card-body">
        <h3 class="h6 text-muted">Reports filed</h3>
        {% if reported_complaints %}
        <ul class="list-group list-group-flush mb-3">
          {% for complaint in reported_complaints[:6] %}
          <li class="list-group-item">
            <div class="fw-semibold">{{ complaint.subject }}</div>
            <div class="text-muted small">Status: {{ complaint.status.replace('_', ' ') }}</div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small">No reports submitted by this teammate.</p>
        {% endif %}
        <h3 class="h6 text-muted">Assigned to</h3>
        {% if assigned_complaints %}
        <ul class="list-group list-group-flush">
          {% for complaint in assigned_complaints[:6] %}
          <li class="list-group-item">
            <div class="fw-semibold">{{ complaint.subject }}</div>
            <div class="text-muted small">Priority: {{ complaint.priority }}</div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted small mb-0">No open HR assignments.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Payroll history</h2>
        <span class="badge bg-primary-soft text-primary">{{ payroll_history|length }} entries</span>
      </div>
      <div class="card-body">
        {% if payroll_history %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">Period</th>
                <th scope="col">Amount</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in payroll_history %}
              <tr>
                <td class="text-muted small">{{ entry.payroll_run.period_start.strftime('%b %d') }} – {{ entry.payroll_run.period_end.strftime('%b %d, %Y') }}</td>
                <td class="fw-semibold">${{ '{:,.2f}'.format(entry.payout_amount or 0) }}</td>
                <td><span class="badge {{ 'bg-success-soft text-success' if entry.payroll_run.status == 'processed' else 'bg-secondary-soft text-secondary' }}">{{ entry.payroll_run.status }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted small mb-0">No payroll entries recorded yet for this teammate.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
