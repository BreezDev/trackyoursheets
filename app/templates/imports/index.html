{% extends 'base.html' %}
{% block title %}Imports · TrackYourSheets{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h4 mb-0">Carrier statement imports</h1>
    <p class="text-muted small mb-0">Drop commission CSVs and we will auto-route rows by carrier into workspace queues.</p>
  </div>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal" {% if not workspaces %}disabled{% endif %}>Upload statements</button>
</div>

{% if not workspaces %}
<div class="alert alert-warning">
  <strong>No workspace access.</strong> Ask an administrator or agent to assign you to a workspace before uploading statements.
</div>
{% endif %}

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Workspace</th>
          <th>Carrier</th>
          <th>Period</th>
          <th>Rows</th>
          <th>Source</th>
          <th>Status</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for batch in batches %}
        <tr>
          <td>{{ batch.workspace.name if batch.workspace else '—' }}</td>
          <td>{{ batch.carrier.name if batch.carrier else '—' }}</td>
          <td>{{ batch.period_month }}</td>
          <td>{{ batch.rows|length }}</td>
          <td>{{ batch.source_type|upper }}</td>
          <td>
            <span class="badge rounded-pill bg-{{ 'success' if batch.status == 'finalized' else 'info' }}-soft text-{{ 'success' if batch.status == 'finalized' else 'info' }}">{{ batch.status|capitalize }}</span>
          </td>
          <td>{{ batch.created_at.strftime('%b %d, %Y %H:%M') if batch.created_at else '' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="5" class="text-center text-muted py-4">No batches imported yet. Upload your first statement to get started.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('imports.upload') }}" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload carrier statements</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            {% if require_workspace_choice %}
            <div class="col-md-4">
              <label class="form-label">Workspace</label>
              <select name="workspace_id" class="form-select" required>
                <option value="" disabled selected>Select workspace</option>
                {% for workspace in workspaces %}
                <option value="{{ workspace.id }}">{{ workspace.office.name ~ ' · ' if workspace.office }}{{ workspace.name }}</option>
                {% endfor %}
              </select>
            </div>
            {% elif workspaces %}
            <input type="hidden" name="workspace_id" value="{{ workspaces[0].id }}">
            {% endif %}
            <div class="col-md-4">
              <label class="form-label">Statement period</label>
              <input type="month" name="period_month" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Source</label>
              <input type="text" class="form-control" value="CSV" disabled>
            </div>
            <div class="col-12">
              <label class="form-label">Files</label>
              <input type="file" name="statement" class="form-control" accept=".csv" required>
              <span class="small text-muted">Include a <strong>carrier</strong> column and we will auto create carrier profiles and sort rows per workspace pipeline.</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
