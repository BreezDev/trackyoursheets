{% extends 'base.html' %}
{% block title %}Interactive Guide Â· TrackYourSheets{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
  <div>
    <h1 class="h4 mb-1">Interactive How-To guide</h1>
    <p class="text-muted mb-0">Search by role, drill into step-by-step checklists, and launch directly into the right workspace tools.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    {% if back_to %}
    <a class="btn btn-outline-secondary" href="{{ back_to }}">Back to admin</a>
    {% endif %}
    <a class="btn btn-primary" href="{{ url_for('main.onboarding') }}">Restart onboarding tour</a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card shadow-sm position-sticky top-0" style="z-index: 100;">
      <div class="card-body">
        <label class="form-label">Find a playbook</label>
        <input type="search" id="guideSearch" class="form-control" placeholder="Search roles, tasks, or keywords">
        <div class="list-group list-group-flush mt-3" id="guideNav">
          {% for section in sections %}
          <a
            href="#role-{{ section.slug }}"
            class="list-group-item list-group-item-action"
            data-guide-nav
            data-guide-target="{{ section.slug }}"
          >{{ section.title }}</a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="accordion" id="guideAccordion">
      {% for section in sections %}
      <div class="accordion-item mb-3" data-guide-role="{{ section.slug }}" data-guide-keywords="{{ section.keywords | join(' ') }}">
        <h2 class="accordion-header" id="heading-{{ section.slug }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ section.slug }}" aria-expanded="false" aria-controls="collapse-{{ section.slug }}">
            <div>
              <div class="fw-semibold">{{ section.title }}</div>
              <div class="small text-muted">{{ section.overview }}</div>
            </div>
          </button>
        </h2>
        <div id="collapse-{{ section.slug }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ section.slug }}" data-bs-parent="#guideAccordion">
          <div class="accordion-body">
            {% for step in section.steps %}
            <div class="mb-4">
              <h3 class="h6 fw-semibold">{{ step.title }}</h3>
              <ul class="list-unstyled mb-0">
                {% for item in step.items %}
                <li class="d-flex align-items-start gap-2 mb-2">
                  <span class="badge bg-primary-soft text-primary rounded-pill">{{ loop.index }}</span>
                  <span>{{ item }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endfor %}
            <div class="alert alert-info mb-0" role="alert">
              Tip: Use the navigation links on the left or press <kbd>/</kbd> to jump straight to the search bar.
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
  const guideSearch = document.getElementById('guideSearch');
  const guideSections = document.querySelectorAll('[data-guide-role]');
  const guideNavLinks = document.querySelectorAll('[data-guide-nav]');

  function normalise(value) {
    return (value || '').toLowerCase();
  }

  function filterGuide(query) {
    const normalized = normalise(query);
    guideSections.forEach((section) => {
      const keywords = normalise(section.getAttribute('data-guide-keywords'));
      const label = normalise(section.querySelector('.fw-semibold').textContent);
      const overview = normalise(section.querySelector('.small').textContent);
      const matches = !normalized || [keywords, label, overview].some((value) => value.includes(normalized));
      section.style.display = matches ? '' : 'none';
      const navLink = document.querySelector(`[data-guide-nav][data-guide-target="${section.getAttribute('data-guide-role')}"]`);
      if (navLink) {
        navLink.classList.toggle('disabled', !matches);
      }
    });
  }

  if (guideSearch) {
    guideSearch.addEventListener('input', (event) => {
      filterGuide(event.target.value);
    });

    window.addEventListener('keydown', (event) => {
      if (event.key === '/' && document.activeElement !== guideSearch) {
        event.preventDefault();
        guideSearch.focus();
      }
    });
  }

  guideNavLinks.forEach((link) => {
    link.addEventListener('click', () => {
      const targetId = link.getAttribute('data-guide-target');
      const panel = document.getElementById(`collapse-${targetId}`);
      if (panel && !panel.classList.contains('show')) {
        const collapse = new bootstrap.Collapse(panel, { toggle: true });
        collapse.show();
      }
    });
  });
</script>
{% endblock %}
