{% extends 'base.html' %}
{% block title %}Interactive Guide Â· TrackYourSheets{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4 gap-3">
  <div>
    <h1 class="h4 mb-1">Interactive How-To guide</h1>
    <p class="text-muted mb-0">Search by role, drill into step-by-step checklists, and launch directly into the right workspace tools.</p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    {% if back_to %}
    <a class="btn btn-outline-secondary" href="{{ back_to }}">Back to admin</a>
    {% endif %}
    <button class="btn btn-outline-primary" type="button" data-start-tour>Take interactive tour</button>
    <a class="btn btn-primary" href="{{ url_for('main.onboarding') }}">Restart onboarding tour</a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card shadow-sm position-sticky top-0" style="z-index: 100;">
      <div class="card-body">
        <label class="form-label">Find a playbook</label>
        <input type="search" id="guideSearch" class="form-control" placeholder="Search roles, tasks, or keywords">
        <div class="list-group list-group-flush mt-3" id="guideNav">
          {% for section in sections %}
          <a
            href="#role-{{ section.slug }}"
            class="list-group-item list-group-item-action"
            data-guide-nav
            data-guide-target="{{ section.slug }}"
          >{{ section.title }}</a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="accordion" id="guideAccordion">
      {% for section in sections %}
      <div class="accordion-item mb-3" data-guide-role="{{ section.slug }}" data-guide-keywords="{{ section.keywords | join(' ') }}">
        <h2 class="accordion-header" id="heading-{{ section.slug }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ section.slug }}" aria-expanded="false" aria-controls="collapse-{{ section.slug }}">
            <div>
              <div class="fw-semibold">{{ section.title }}</div>
              <div class="small text-muted">{{ section.overview }}</div>
            </div>
          </button>
        </h2>
        <div id="collapse-{{ section.slug }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ section.slug }}" data-bs-parent="#guideAccordion">
          <div class="accordion-body">
            {% for step in section.steps %}
            <div class="mb-4">
              <h3 class="h6 fw-semibold">{{ step.title }}</h3>
              <ul class="list-unstyled mb-0">
                {% for item in step.items() %}
                <li class="d-flex align-items-start gap-2 mb-2">
                  <span class="badge bg-primary-soft text-primary rounded-pill">{{ loop.index }}</span>
                  <span>{{ item }}</span>
                </li>
                {% endfor %}
              </ul>
            </div>
            {% endfor %}
            <div class="alert alert-info mb-0" role="alert">
              Tip: Use the navigation links on the left or press <kbd>/</kbd> to jump straight to the search bar.
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

<div class="modal fade" id="guideTourModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title h5 mb-0" data-tour-title>TrackYourSheets tour</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="lead" data-tour-description></p>
        <a class="btn btn-primary" data-tour-cta href="#" target="_blank" rel="noopener">Open section</a>
      </div>
      <div class="modal-footer d-flex justify-content-between align-items-center">
        <button class="btn btn-outline-secondary" type="button" data-tour-prev>Previous</button>
        <div class="d-flex align-items-center gap-3">
          <span class="text-muted small" data-tour-progress></span>
          <button class="btn btn-primary" type="button" data-tour-next>Next</button>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const guideSearch = document.getElementById('guideSearch');
    const guideSections = document.querySelectorAll('[data-guide-role]');
    const guideNavLinks = document.querySelectorAll('[data-guide-nav]');
    const tourSteps = {{ tour_steps|tojson|safe }};

    const normalise = (value) => (value || '').toLowerCase();

    const filterGuide = (query) => {
      const normalized = normalise(query);
      guideSections.forEach((section) => {
        const keywords = normalise(section.getAttribute('data-guide-keywords'));
        const label = normalise(section.querySelector('.fw-semibold').textContent);
        const overview = normalise(section.querySelector('.small').textContent);
        const matches = !normalized || [keywords, label, overview].some((value) => value.includes(normalized));
        section.style.display = matches ? '' : 'none';
        const navLink = document.querySelector(`[data-guide-nav][data-guide-target="${section.getAttribute('data-guide-role')}"]`);
        if (navLink) {
          navLink.classList.toggle('disabled', !matches);
        }
      });
    };

    if (guideSearch) {
      guideSearch.addEventListener('input', (event) => {
        filterGuide(event.target.value);
      });

      window.addEventListener('keydown', (event) => {
        if (event.key === '/' && document.activeElement !== guideSearch) {
          event.preventDefault();
          guideSearch.focus();
        }
      });
    }

    guideNavLinks.forEach((link) => {
      link.addEventListener('click', () => {
        const targetId = link.getAttribute('data-guide-target');
        const panel = document.getElementById(`collapse-${targetId}`);
        if (panel && !panel.classList.contains('show')) {
          const collapse = new bootstrap.Collapse(panel, { toggle: true });
          collapse.show();
        }
      });
    });

    const tourModalEl = document.getElementById('guideTourModal');
    const tourStartButtons = document.querySelectorAll('[data-start-tour]');
    if (tourModalEl && Array.isArray(tourSteps) && tourSteps.length) {
      const modal = new bootstrap.Modal(tourModalEl);
      const titleEl = tourModalEl.querySelector('[data-tour-title]');
      const descriptionEl = tourModalEl.querySelector('[data-tour-description]');
      const ctaEl = tourModalEl.querySelector('[data-tour-cta]');
      const progressEl = tourModalEl.querySelector('[data-tour-progress]');
      const prevButton = tourModalEl.querySelector('[data-tour-prev]');
      const nextButton = tourModalEl.querySelector('[data-tour-next]');
      let currentStep = 0;

      const renderStep = (index) => {
        const step = tourSteps[index];
        if (!step) {
          return;
        }
        if (titleEl) {
          titleEl.textContent = step.title || 'Interactive tour';
        }
        if (descriptionEl) {
          descriptionEl.textContent = step.description || '';
        }
        if (ctaEl) {
          if (step.cta_url) {
            ctaEl.href = step.cta_url;
            ctaEl.textContent = step.cta_label || 'Open section';
            ctaEl.classList.remove('disabled');
          } else {
            ctaEl.href = '#';
            ctaEl.textContent = 'Open section';
            ctaEl.classList.add('disabled');
          }
        }
        if (progressEl) {
          progressEl.textContent = `Step ${index + 1} of ${tourSteps.length}`;
        }
        if (prevButton) {
          prevButton.disabled = index === 0;
        }
        if (nextButton) {
          nextButton.textContent = index === tourSteps.length - 1 ? 'Finish' : 'Next';
        }
      };

      const goToStep = (index) => {
        if (index < 0 || index >= tourSteps.length) {
          return;
        }
        currentStep = index;
        renderStep(currentStep);
      };

      if (prevButton) {
        prevButton.addEventListener('click', () => {
          if (currentStep > 0) {
            goToStep(currentStep - 1);
          }
        });
      }

      if (nextButton) {
        nextButton.addEventListener('click', () => {
          if (currentStep < tourSteps.length - 1) {
            goToStep(currentStep + 1);
          } else {
            modal.hide();
          }
        });
      }

      tourStartButtons.forEach((button) => {
        button.addEventListener('click', () => {
          goToStep(0);
          modal.show();
        });
      });
    }
  });
</script>
{% endblock %}
