{% extends 'base.html' %}
{% block title %}Dashboard · TrackYourSheets{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-xl-4 col-md-6">
    <div class="card stat-card shadow-sm">
      <div class="card-body">
        <span class="badge bg-primary-soft text-primary">Commission activity</span>
        <h2 class="display-6 fw-semibold mt-2">{{ txns_total }}</h2>
        <p class="text-muted mb-0">Commission transactions tracked</p>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-6">
    <div class="card stat-card shadow-sm">
      <div class="card-body">
        <span class="badge bg-success-soft text-success">Imports</span>
        <h2 class="display-6 fw-semibold mt-2">{{ imports|length }}</h2>
        <p class="text-muted mb-0">Recent carrier statements processed</p>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-12">
    <div class="card stat-card shadow-sm">
      <div class="card-body">
        <span class="badge bg-warning-soft text-warning">Audit</span>
        <h2 class="display-6 fw-semibold mt-2">{{ audit_events|length }}</h2>
        <p class="text-muted mb-0">Latest ledger and rule adjustments</p>
      </div>
    </div>
  </div>
</div>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h5 mb-0">Workspace notes</h2>
      <p class="text-muted small mb-0">Capture personal reminders or share updates with your office. Notes auto-save.</p>
    </div>
    {% if workspaces %}
    <form method="get" class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small text-muted" for="workspaceSwitcher">Workspace</label>
      <select id="workspaceSwitcher" name="workspace_id" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for workspace in workspaces %}
        <option value="{{ workspace.id }}" {% if active_workspace and active_workspace.id == workspace.id %}selected{% endif %}>
          {{ workspace.office.name if workspace.office }}{% if workspace.office %} · {% endif %}{{ workspace.name }}
        </option>
        {% endfor %}
      </select>
    </form>
    {% endif %}
  </div>
  {% if not active_workspace %}
  <div class="alert alert-warning">Assign a workspace to start capturing notes.</div>
  {% else %}
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h3 class="h6">Personal notes</h3>
          <textarea class="form-control" rows="8" data-note-scope="personal" data-workspace-id="{{ active_workspace.id }}">{{ personal_note.content if personal_note else '' }}</textarea>
          <div class="form-text small text-muted">
            <div>Only you can see these notes.</div>
            <div data-note-status="personal">
              {% if personal_note_meta %}
              Last updated by {{ personal_note_meta.editor }} on {{ personal_note_meta.timestamp }}
              {% else %}
              Not saved yet.
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h3 class="h6">Shared workspace board</h3>
          <textarea class="form-control" rows="8" data-note-scope="shared" data-workspace-id="{{ active_workspace.id }}">{{ shared_note.content if shared_note else '' }}</textarea>
          <div class="form-text small text-muted">
            <div>Visible to everyone assigned to this workspace.</div>
            <div data-note-status="shared">
              {% if shared_note_meta %}
              Last updated by {{ shared_note_meta.editor }} on {{ shared_note_meta.timestamp }}
              {% else %}
              Not saved yet.
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h5 mb-0">Workspace chat</h2>
      <p class="text-muted small mb-0">Coordinate live updates, renewal reminders, and approvals without leaving TrackYourSheets.</p>
    </div>
    {% if active_workspace %}
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary" type="button" data-chat-refresh>Refresh</button>
    </div>
    {% endif %}
  </div>
  {% if not active_workspace %}
  <div class="alert alert-warning">Assign a workspace to unlock real-time chat.</div>
  {% else %}
  <div class="card shadow-sm">
    <div class="card-body d-flex flex-column gap-3">
      <div class="chat-message-list border rounded" style="max-height: 360px; overflow-y: auto;" data-chat-scroll>
        <ul class="list-group list-group-flush" data-chat-messages>
          {% for message in chat_messages %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-semibold">{{ message.author.display_name_for_ui if message.author else 'Unknown user' }}</span>
              <span class="text-muted small">{{ message.created_at.strftime('%b %d, %Y %I:%M %p') if message.created_at else '' }}</span>
            </div>
            <div class="mt-1 small">{{ message.content }}</div>
          </li>
          {% else %}
          <li class="list-group-item text-center text-muted py-3">Start the conversation by sending the first update below.</li>
          {% endfor %}
        </ul>
      </div>
      <form id="workspaceChatForm" data-workspace-id="{{ active_workspace.id }}">
        <label class="form-label" for="workspaceChatMessage">Send a message</label>
        <textarea class="form-control" id="workspaceChatMessage" rows="2" placeholder="Share a win, ask a question, or drop a reminder" required></textarea>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <small class="text-muted" data-chat-status>Messages are shared with everyone assigned to this workspace.</small>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-chat-refresh>Refresh</button>
            <button class="btn btn-sm btn-primary" type="submit">Send</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0">Recent imports</h2>
    <a class="btn btn-sm btn-primary" href="{{ url_for('imports.index') }}">New import</a>
  </div>
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Carrier</th>
            <th>Period</th>
            <th>Source</th>
            <th>Status</th>
            <th>Uploaded</th>
          </tr>
        </thead>
        <tbody>
          {% for batch in imports %}
          <tr>
            <td>{{ batch.carrier.name if batch.carrier else '—' }}</td>
            <td>{{ batch.period_month }}</td>
            <td>{{ batch.source_type|upper }}</td>
            <td><span class="badge rounded-pill bg-info-soft text-info">{{ batch.status|capitalize }}</span></td>
            <td>{{ batch.created_at.strftime('%b %d, %Y') if batch.created_at else '' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No imports yet. <a href="{{ url_for('imports.index') }}">Upload your first statement.</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0">Audit trail</h2>
    <span class="text-muted small">Immutable logs for compliance</span>
  </div>
  <div class="card shadow-sm">
    <div class="list-group list-group-flush">
      {% for event in audit_events %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>{{ event.action }}</strong>
            <span class="text-muted">on {{ event.entity }} #{{ event.entity_id }}</span>
          </div>
          <span class="text-muted small">{{ event.ts.strftime('%b %d, %Y %H:%M') }}</span>
        </div>
        <p class="small text-muted mb-0">Performed by user ID {{ event.actor_user_id }}</p>
      </div>
      {% else %}
      <div class="list-group-item text-center text-muted py-4">
        Audit log will populate as you import, reconcile, and finalize months.
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

  {% block extra_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const debounceTimers = {};
      const formatNoteStatus = (editor, timestamp) => {
        if (!editor || !timestamp) {
          return 'All changes saved.';
        }
        return `Last updated by ${editor} on ${timestamp}`;
      };

      document.querySelectorAll('[data-note-scope]').forEach((textarea) => {
        textarea.addEventListener('input', () => {
          const scope = textarea.dataset.noteScope;
          const workspaceId = textarea.dataset.workspaceId;
          const statusEl = document.querySelector(`[data-note-status="${scope}"]`);
          if (statusEl) {
            statusEl.textContent = 'Saving…';
          }
          clearTimeout(debounceTimers[scope]);
          debounceTimers[scope] = setTimeout(() => {
            fetch(`/notes/${scope}`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                content: textarea.value,
                workspace_id: workspaceId
              })
            })
              .then((response) => (response.ok ? response.json() : Promise.reject(response)))
              .then((payload) => {
                if (statusEl) {
                  statusEl.textContent = formatNoteStatus(payload.editor, payload.updated_at_display);
                }
              })
              .catch(() => {
                if (statusEl) {
                  statusEl.textContent = 'Unable to save. Check your connection.';
                }
              });
          }, 600);
        });
      });

      const chatContainer = document.querySelector('[data-chat-messages]');
      const chatForm = document.getElementById('workspaceChatForm');
      const chatStatus = document.querySelector('[data-chat-status]');
      const chatScroll = document.querySelector('[data-chat-scroll]');
      const chatRefreshButtons = document.querySelectorAll('[data-chat-refresh]');
      const initialChatMessages = {{ chat_messages_payload|tojson|safe }};

      const formatTimestamp = (value, fallback) => {
        if (!value) {
          return fallback || '';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return fallback || '';
        }
        return date.toLocaleString();
      };

      const renderMessages = (messages) => {
        if (!chatContainer) {
          return;
        }
        chatContainer.innerHTML = '';
        if (!messages.length) {
          const emptyItem = document.createElement('li');
          emptyItem.className = 'list-group-item text-center text-muted py-3';
          emptyItem.textContent = 'Start the conversation by sending the first update below.';
          chatContainer.append(emptyItem);
          return;
        }
        messages.forEach((message) => {
          const item = document.createElement('li');
          item.className = 'list-group-item';

          const header = document.createElement('div');
          header.className = 'd-flex justify-content-between align-items-center';

          const author = document.createElement('span');
          author.className = 'fw-semibold';
          author.textContent = message.author || 'Unknown user';

          const timestamp = document.createElement('span');
          timestamp.className = 'text-muted small';
          timestamp.textContent = message.created_at_display || formatTimestamp(message.created_at);

          header.append(author, timestamp);

          const body = document.createElement('div');
          body.className = 'mt-1 small';
          body.textContent = message.content;

          item.append(header, body);
          chatContainer.append(item);
        });
        if (chatScroll) {
          chatScroll.scrollTop = chatScroll.scrollHeight;
        }
      };

      const setChatStatus = (message) => {
        if (chatStatus) {
          chatStatus.textContent = message;
        }
      };

      const refreshChat = (silent = false) => {
        if (!chatForm) {
          return;
        }
        if (!silent) {
          setChatStatus('Refreshing…');
        }
        const workspaceId = chatForm.dataset.workspaceId;
        fetch(`/chat/${workspaceId}/messages`)
          .then((response) => (response.ok ? response.json() : Promise.reject(response)))
          .then((messages) => {
            if (Array.isArray(initialChatMessages)) {
              initialChatMessages.splice(0, initialChatMessages.length, ...messages);
            }
            renderMessages(messages);
            if (!silent) {
              setChatStatus('Chat updated.');
            }
          })
          .catch(() => {
            if (!silent) {
              setChatStatus('Unable to refresh chat right now.');
            }
          });
      };

      if (Array.isArray(initialChatMessages) && initialChatMessages.length) {
        renderMessages(initialChatMessages);
      }

      if (chatForm) {
        chatForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const workspaceId = chatForm.dataset.workspaceId;
          const textarea = chatForm.querySelector('textarea');
          if (!textarea) {
            return;
          }
          const message = textarea.value.trim();
          if (!message) {
            return;
          }
          const submitButton = chatForm.querySelector('button[type="submit"]');
          if (submitButton) {
            submitButton.disabled = true;
          }
          setChatStatus('Sending…');
          fetch(`/chat/${workspaceId}/messages`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: message}),
          })
            .then((response) => (response.ok ? response.json() : Promise.reject(response)))
            .then((payload) => {
              textarea.value = '';
              const updatedMessages = Array.isArray(initialChatMessages) ? [...initialChatMessages, payload] : [payload];
              initialChatMessages.splice(0, initialChatMessages.length, ...updatedMessages);
              renderMessages(initialChatMessages);
              setChatStatus('Message delivered.');
            })
            .catch(() => {
              setChatStatus('Unable to send message. Try again.');
            })
            .finally(() => {
              if (submitButton) {
                submitButton.disabled = false;
              }
            });
        });

        chatRefreshButtons.forEach((button) => {
          button.addEventListener('click', () => refreshChat());
        });

        setInterval(() => refreshChat(true), 45000);
      }
    });
  </script>
  {% endblock %}
