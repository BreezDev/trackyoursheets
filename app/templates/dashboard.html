{% extends 'base.html' %}
{% block title %}Dashboard Â· TrackYourSheets{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-xl-4 col-md-6">
    <div class="card stat-card shadow-sm">
      <div class="card-body">
        <span class="badge bg-primary-soft text-primary">Commission activity</span>
        <h2 class="display-6 fw-semibold mt-2">{{ txns_total }}</h2>
        <p class="text-muted mb-0">Commission transactions tracked</p>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-6">
    <div class="card stat-card shadow-sm">
      <div class="card-body">
        <span class="badge bg-success-soft text-success">Imports</span>
        <h2 class="display-6 fw-semibold mt-2">{{ imports|length }}</h2>
        <p class="text-muted mb-0">Recent carrier statements processed</p>
      </div>
    </div>
  </div>
  <div class="col-xl-4 col-md-12">
    <div class="card stat-card shadow-sm">
      <div class="card-body">
        <span class="badge bg-warning-soft text-warning">Audit</span>
        <h2 class="display-6 fw-semibold mt-2">{{ audit_total }}</h2>
        <p class="text-muted mb-0">Audit events captured across your org</p>
      </div>
    </div>
  </div>
</div>

<section class="mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-3">
      <div>
        <h2 class="h6 mb-1">Premium collected</h2>
        <p class="text-muted small mb-0" data-premium-summary>Comparing today, week, month, quarter, and year totals.</p>
      </div>
      <div class="btn-group btn-group-sm" role="group" aria-label="Premium filters">
        <button type="button" class="btn btn-outline-primary active" data-premium-range="all">All</button>
        <button type="button" class="btn btn-outline-primary" data-premium-range="today">Today</button>
        <button type="button" class="btn btn-outline-primary" data-premium-range="week">This week</button>
        <button type="button" class="btn btn-outline-primary" data-premium-range="month">This month</button>
        <button type="button" class="btn btn-outline-primary" data-premium-range="quarter">Quarter</button>
        <button type="button" class="btn btn-outline-primary" data-premium-range="year">Year</button>
      </div>
    </div>
    <div class="card-body">
      <canvas id="premiumChart" height="160" data-premium-currency="{{ premium_currency }}"></canvas>
    </div>
  </div>
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h5 mb-0">Workspace notes</h2>
      <p class="text-muted small mb-0">Capture personal reminders or share updates with your office. Notes auto-save.</p>
    </div>
    {% if workspaces %}
    <form method="get" class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small text-muted" for="workspaceSwitcher">Workspace</label>
      <select id="workspaceSwitcher" name="workspace_id" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for workspace in workspaces %}
        <option value="{{ workspace.id }}" {% if active_workspace and active_workspace.id == workspace.id %}selected{% endif %}>
          {{ workspace.office.name if workspace.office }}{% if workspace.office %} Â· {% endif %}{{ workspace.name }}
        </option>
        {% endfor %}
      </select>
    </form>
    {% endif %}
  </div>
  {% if not active_workspace %}
  <div class="alert alert-warning">Assign a workspace to start capturing notes.</div>
  {% else %}
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h3 class="h6">Personal notes</h3>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-secondary-soft text-secondary">Private</span>
            <small class="text-muted" data-note-status="personal">
              {% if personal_note_meta %}
              <i class="bi bi-person"></i> {{ personal_note_meta.editor }} Â· <i class="bi bi-clock-history"></i> {{ personal_note_meta.timestamp }}
              {% else %}
              Not saved yet.
              {% endif %}
            </small>
          </div>
          <textarea class="form-control" rows="8" data-note-scope="personal" data-workspace-id="{{ active_workspace.id }}">{{ personal_note.content if personal_note else '' }}</textarea>
          <div class="form-text small text-muted">Only you can see these notes.</div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h3 class="h6">Shared workspace board</h3>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-primary-soft text-primary">Shared</span>
            <small class="text-muted" data-note-status="shared">
              {% if shared_note_meta %}
              <i class="bi bi-people"></i> {{ shared_note_meta.editor }} Â· <i class="bi bi-clock-history"></i> {{ shared_note_meta.timestamp }}
              {% else %}
              Not saved yet.
              {% endif %}
            </small>
          </div>
          <textarea class="form-control" rows="8" data-note-scope="shared" data-workspace-id="{{ active_workspace.id }}">{{ shared_note.content if shared_note else '' }}</textarea>
          <div class="form-text small text-muted">Visible to everyone assigned to this workspace.</div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="h5 mb-0">Workspace chat</h2>
      <p class="text-muted small mb-0">Coordinate live updates, renewal reminders, and approvals without leaving TrackYourSheets.</p>
    </div>
    {% if active_workspace %}
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary" type="button" data-chat-refresh>Refresh</button>
    </div>
    {% endif %}
  </div>
  {% if not active_workspace %}
  <div class="alert alert-warning">Assign a workspace to unlock real-time chat.</div>
  {% else %}
  <div class="card shadow-sm">
    <div class="card-body d-flex flex-column gap-3">
      <div class="chat-message-list border rounded" style="max-height: 360px; overflow-y: auto;" data-chat-scroll>
        <ul class="list-group list-group-flush" data-chat-messages>
          {% for message in chat_messages %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-semibold">{{ message.author.display_name_for_ui if message.author else 'Unknown user' }}</span>
              <span class="text-muted small">{{ message.created_at.strftime('%b %d, %Y %I:%M %p') if message.created_at else '' }}</span>
            </div>
            <div class="mt-1 small">{{ message.rendered_content|safe }}</div>
          </li>
          {% else %}
          <li class="list-group-item text-center text-muted py-3">Start the conversation by sending the first update below.</li>
          {% endfor %}
        </ul>
      </div>
      <form id="workspaceChatForm" data-workspace-id="{{ active_workspace.id }}">
        <label class="form-label" for="workspaceChatMessage">Send a message</label>
        <textarea class="form-control" id="workspaceChatMessage" rows="2" placeholder="Share a win, ask a question, or drop a reminder" required></textarea>
        <div class="d-flex align-items-center gap-2 mt-2">
          <div class="btn-group dropup">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              ğŸ˜Š Emoji
            </button>
            <div class="dropdown-menu p-2 shadow-sm" style="min-width: 220px;">
              <div class="d-flex flex-wrap gap-2" data-emoji-palette>
                {% for emoji in ['ğŸ‰','ğŸ”¥','âœ…','ğŸ’¡','ğŸš€','ğŸ“£','ğŸ™','ğŸ‘','ğŸ“','ğŸ“Š','ğŸŒŸ','â°'] %}
                <button type="button" class="btn btn-sm btn-light" data-emoji="{{ emoji }}">{{ emoji }}</button>
                {% endfor %}
              </div>
            </div>
          </div>
          <small class="text-muted">Tag teammates with @ and sprinkle emojis to celebrate wins.</small>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <small class="text-muted" data-chat-status>Messages are shared with everyone assigned to this workspace.</small>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-chat-refresh>Refresh</button>
            <button class="btn btn-sm btn-primary" type="submit">Send</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</section>

<section class="mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0">Recent imports</h2>
    <a class="btn btn-sm btn-primary" href="{{ url_for('imports.index') }}">New import</a>
  </div>
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Carrier</th>
            <th>Period</th>
            <th>Source</th>
            <th>Status</th>
            <th>Uploaded</th>
          </tr>
        </thead>
        <tbody>
          {% for batch in imports %}
          <tr>
            <td>{{ batch.carrier.name if batch.carrier else 'â€”' }}</td>
            <td>{{ batch.period_month }}</td>
            <td>{{ batch.source_type|upper }}</td>
            <td><span class="badge rounded-pill bg-info-soft text-info">{{ batch.status|capitalize }}</span></td>
            <td>{{ batch.created_at.strftime('%b %d, %Y') if batch.created_at else '' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No imports yet. <a href="{{ url_for('imports.index') }}">Upload your first statement.</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="mt-5">
  <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center gap-2 mb-3">
    <div>
      <h2 class="h5 mb-0">Audit trail</h2>
      <p class="text-muted small mb-0">Most recent automation and teammate activity.</p>
    </div>
    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('main.audit_trail') }}">Open full audit log</a>
  </div>
  <div class="card shadow-sm">
    <div class="list-group list-group-flush">
      {% for entry in audit_entries %}
      <div class="list-group-item">
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-start gap-2">
          <div>
            <div class="fw-semibold">{{ entry.action }}</div>
            <div class="text-muted small">
              {% if entry.entity %}{{ entry.entity }}{% else %}Entity not recorded{% endif %}
              {% if entry.entity_id %}Â· #{{ entry.entity_id }}{% endif %}
            </div>
            <div class="text-muted small">{{ entry.actor_display }} Â· {{ entry.timestamp_display }}</div>
          </div>
          <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardAudit{{ entry.id }}" aria-expanded="false" aria-controls="dashboardAudit{{ entry.id }}">
            View details
          </button>
        </div>
        <div class="collapse mt-3" id="dashboardAudit{{ entry.id }}">
          <div class="bg-light border rounded p-3">
            {% if entry.before %}
            <h6 class="small text-uppercase text-muted fw-semibold">Before</h6>
            <pre class="small mb-3">{{ entry.before | tojson(indent=2) }}</pre>
            {% endif %}
            {% if entry.after %}
            <h6 class="small text-uppercase text-muted fw-semibold">After</h6>
            <pre class="small mb-0">{{ entry.after | tojson(indent=2) }}</pre>
            {% endif %}
            {% if not entry.before and not entry.after %}
            <p class="small text-muted mb-0">No field-level context recorded for this action.</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="list-group-item text-center text-muted py-4">
        Audit log will populate as you import, reconcile, and finalize months.
      </div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" integrity="sha384-4G8VwKCbFf8gLZZQzQ0jrISFRCGDpa2BkLomqKgkl0vvArkH5AO9M/dwZ0pniS3p" crossorigin="anonymous"></script>
  <script>
    window.TrackYourSheets = window.TrackYourSheets || {};
    window.TrackYourSheets.premiumTotals = {{ premium_totals|tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const debounceTimers = {};
      const formatNoteStatus = (editor, timestamp) => {
        if (!editor || !timestamp) {
          return 'Not saved yet.';
        }
        return `<i class="bi bi-person"></i> ${editor} Â· <i class="bi bi-clock-history"></i> ${timestamp}`;
      };

      document.querySelectorAll('[data-note-scope]').forEach((textarea) => {
        textarea.addEventListener('input', () => {
          const scope = textarea.dataset.noteScope;
          const workspaceId = textarea.dataset.workspaceId;
          const statusEl = document.querySelector(`[data-note-status="${scope}"]`);
          if (statusEl) {
            statusEl.textContent = 'Savingâ€¦';
          }
          clearTimeout(debounceTimers[scope]);
          debounceTimers[scope] = setTimeout(() => {
            fetch(`/notes/${scope}`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                content: textarea.value,
                workspace_id: workspaceId
              })
            })
              .then((response) => (response.ok ? response.json() : Promise.reject(response)))
              .then((payload) => {
                if (statusEl) {
                  statusEl.innerHTML = formatNoteStatus(payload.editor, payload.updated_at_display);
                }
              })
              .catch(() => {
                if (statusEl) {
                  statusEl.textContent = 'Unable to save. Check your connection.';
                }
              });
          }, 600);
        });
      });

      const chatContainer = document.querySelector('[data-chat-messages]');
      const chatForm = document.getElementById('workspaceChatForm');
      const chatStatus = document.querySelector('[data-chat-status]');
      const chatScroll = document.querySelector('[data-chat-scroll]');
      const chatRefreshButtons = document.querySelectorAll('[data-chat-refresh]');
      const initialChatMessages = {{ chat_messages_payload|tojson|safe }};

      const formatTimestamp = (value, fallback) => {
        if (!value) {
          return fallback || '';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return fallback || '';
        }
        return date.toLocaleString();
      };

      const renderMessages = (messages) => {
        if (!chatContainer) {
          return;
        }
        chatContainer.innerHTML = '';
        if (!messages.length) {
          const emptyItem = document.createElement('li');
          emptyItem.className = 'list-group-item text-center text-muted py-3';
          emptyItem.textContent = 'Start the conversation by sending the first update below.';
          chatContainer.append(emptyItem);
          return;
        }
        messages.forEach((message) => {
          const item = document.createElement('li');
          item.className = 'list-group-item';

          const header = document.createElement('div');
          header.className = 'd-flex justify-content-between align-items-center';

          const author = document.createElement('span');
          author.className = 'fw-semibold';
          author.textContent = message.author || 'Unknown user';

          const timestamp = document.createElement('span');
          timestamp.className = 'text-muted small';
          timestamp.textContent = message.created_at_display || formatTimestamp(message.created_at);

          header.append(author, timestamp);

          const body = document.createElement('div');
          body.className = 'mt-1 small';
          if (message.content_html) {
            body.innerHTML = message.content_html;
          } else {
            body.textContent = message.content;
          }

          item.append(header, body);
          chatContainer.append(item);
        });
        if (chatScroll) {
          chatScroll.scrollTop = chatScroll.scrollHeight;
        }
      };

      const setChatStatus = (message) => {
        if (chatStatus) {
          chatStatus.textContent = message;
        }
      };

      const refreshChat = (silent = false) => {
        if (!chatForm) {
          return;
        }
        if (!silent) {
          setChatStatus('Refreshingâ€¦');
        }
        const workspaceId = chatForm.dataset.workspaceId;
        fetch(`/chat/${workspaceId}/messages`)
          .then((response) => (response.ok ? response.json() : Promise.reject(response)))
          .then((messages) => {
            if (Array.isArray(initialChatMessages)) {
              initialChatMessages.splice(0, initialChatMessages.length, ...messages);
            }
            renderMessages(messages);
            if (!silent) {
              setChatStatus('Chat updated.');
            }
          })
          .catch(() => {
            if (!silent) {
              setChatStatus('Unable to refresh chat right now.');
            }
          });
      };

      if (Array.isArray(initialChatMessages) && initialChatMessages.length) {
        renderMessages(initialChatMessages);
      }

      if (chatForm) {
        const textarea = chatForm.querySelector('textarea');
        const emojiButtons = chatForm.querySelectorAll('[data-emoji]');
        emojiButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const emoji = button.getAttribute('data-emoji');
            if (!textarea || !emoji) {
              return;
            }
            const start = textarea.selectionStart || textarea.value.length;
            const end = textarea.selectionEnd || textarea.value.length;
            const current = textarea.value;
            textarea.value = `${current.slice(0, start)}${emoji} ${current.slice(end)}`;
            textarea.focus();
            const cursor = start + emoji.length + 1;
            textarea.setSelectionRange(cursor, cursor);
          });
        });

        chatForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const workspaceId = chatForm.dataset.workspaceId;
          if (!textarea) {
            return;
          }
          const message = textarea.value.trim();
          if (!message) {
            return;
          }
          const submitButton = chatForm.querySelector('button[type="submit"]');
          if (submitButton) {
            submitButton.disabled = true;
          }
          setChatStatus('Sendingâ€¦');
          fetch(`/chat/${workspaceId}/messages`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({content: message}),
          })
            .then((response) => (response.ok ? response.json() : Promise.reject(response)))
            .then((payload) => {
              textarea.value = '';
              const updatedMessages = Array.isArray(initialChatMessages) ? [...initialChatMessages, payload] : [payload];
              initialChatMessages.splice(0, initialChatMessages.length, ...updatedMessages);
              renderMessages(initialChatMessages);
              setChatStatus('Message delivered.');
            })
            .catch(() => {
              setChatStatus('Unable to send message. Try again.');
            })
            .finally(() => {
              if (submitButton) {
                submitButton.disabled = false;
              }
            });
        });

        chatRefreshButtons.forEach((button) => {
          button.addEventListener('click', () => refreshChat());
        });

        setInterval(() => refreshChat(true), 45000);
      }
    });
  </script>
  {% endblock %}
